= Modeling cocard
:author: Wolfgang Barth
:revdate: 2024-04-27
:imagesdir: ../images

== Overall Picture

image::models.svg[]

== Home controller

[source,sh]
----
bin/rails g controller Home index \
  --no-stylesheets --no-javascripts --no-helper
----

== model Location

[source,sh]
----
bin/rails g scaffold Location \
  lid:string \
  description:string \
  --no-stylesheets --no-javascripts --no-helper
----

i.e. `NRH`, `BNA`. Only for grouping and information.

== model Context

Context for SOAP requests.

[source,sh]
----
bin/rails g scaffold Context \
  mandant:string \
  client_system:string \
  workplace:string \
  description:string \
  --no-stylesheets --no-javascripts --no-helper
----

i.e. `ORBIS`, `Ein1`. Used as `Mandant_id` in SOAP requests.

== model Connector

[source,sh]
----
bin/rails g scaffold Connector \
  name:string \
  ip:inet \
  sds_url:string \
  manual_update:boolean \
    --no-stylesheets --no-javascripts --no-helper

bin/rails g migration AddReadonlyToConnector \
  sds_xml:text \
  sds_updated_at: \
  connector_services:jsonb \
  last_check:timestamp last_check_ok:timestamp \
  condition:integer:index \
  soap_request_success:boolean \
  vpnti_online:boolean
----

.Install ActionText
[source,sh]
----
bin/rails action_text:install
----

.app/models/connector.rb
[source,ruby]
----
class Connector < ApplicationRecord
  has_rich_text :description
end
----

== model CardTerminal

[source,sh]
----
bin/rails g scaffold CardTerminal \
  displayname:string \
  location:belongs_to \
    --no-stylesheets --no-javascripts --no-helper

bin/rails g migration AddInternalToCardTerminal \
  properties:jsonb \
  name:string \
  ctid:string \
  mac:macaddr \
  ip:inet \
  connected:boolean \
  condition:integer \
  connector:belongs_to
----


.app/models/card_terminal.rb
[source,ruby]
----
class CardTerminal < ApplicationRecord
  has_rich_text :description
end
----


== HABTM Tables

.Join Tables for HABTM
[source,sh]
----
bin/rails g migration CreateJoinTableConnectorLocation \
  connector location
----

Add index and set index to unique:

[source,ruby]
----
class CreateJoinTableConnectorLocation < ActiveRecord::Migration[7.1]
  def change
    create_join_table :connectors, :locations do |t|
      t.index [:location_id, :connector_id], unique: true
      t.index [:connector_id, :location_id], unique: true
    end
  end
end
----

== HABTM Connector -- Context through ConnectorContext

HABTM for Connector and Context with additional attributes

[source,sh]
----
bin/rails g model ConnectorContext \
  connector:belongs_to \
  context:belongs_to \
  position:integer:index \
  --no-stylesheets --no-javascripts --no-helper
----

.Unique Index for ConnectorContext
[source,ruby]
----
t.index [:connector_id, :context_id], unique: true
t.index [:context_id, :connector_id], unique: true
----